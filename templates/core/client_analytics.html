{% extends 'core/base_client.html' %}
{% load static %}

{% block title %}
  Post Analytics
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-body p-3">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between mb-0">
            <h4 class="font-size-22 fw-bold">Post Analytics</h4>
            <div class="page-title-right">
              <ol class="breadcrumb m-0">
                <li class="breadcrumb-item">
                  <a href="{% url 'core:client_dashboard' %}">Dashboard</a>
                </li>
                <li class="breadcrumb-item active">Analytics</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-4 col-md-6">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">Total Posts</p>
              <h4 class="mb-0">{{ total_posts_count }}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle bg-primary-subtle text-primary">
                <span class="avatar-title"><i class="bx bx-file font-size-24"></i></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">Posts Published</p>
              <h4 class="mb-0">{{ published_count }}</h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle bg-success-subtle text-success">
                <span class="avatar-title"><i class="bx bx-check-double font-size-24"></i></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6">
      <div class="card mini-stats-wid">
        <div class="card-body">
          <div class="d-flex">
            <div class="flex-grow-1">
              <p class="text-muted fw-medium">Average Rating</p>
              <h4 class="mb-0">{{ avg_rating|floatformat:2 }} <span class="font-size-14 text-muted">/ 5</span></h4>
            </div>
            <div class="flex-shrink-0 align-self-center">
              <div class="mini-stat-icon avatar-sm rounded-circle bg-warning-subtle text-warning">
                <span class="avatar-title"><i class="bx bxs-star font-size-24"></i></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-5">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title mb-0">Post Status Distribution</h4>
        </div>
        <div class="card-body">
          <canvas id="statusPieChart" height="300"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title mb-0">Your Top-Rated Posts</h4>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table align-middle table-nowrap mb-0">
              <thead class="table-light">
                <tr>
                  <th>Post Title</th>
                  <th>Average Rating</th>
                </tr>
              </thead>
              <tbody>
                {% for post in top_rated_posts %}
                  <tr>
                    <td>
                      <h5 class="font-size-14 mb-1">{{ post.title }}</h5>
                      <p class="text-muted mb-0">{{ post.caption|truncatewords:10 }}</p>
                    </td>
                    <td>
                      <h5 class="mb-0 text-warning">
                        <i class="bx bxs-star"></i>
                        {{ post.avg_score|floatformat:2 }}
                      </h5>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="2" class="text-center p-4">
                      <p class="text-muted my-2">No rated posts yet.</p>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title mb-0">Most Discussed Posts</h4>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table align-middle table-nowrap mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 100px;">Preview</th>
                  <th>Post Details</th>
                  <th>Total Comments</th>
                </tr>
              </thead>
              <tbody>
                {% for post in most_discussed_posts %}
                  <tr>
                    <td>
                      <img src="{{ post.image.url }}" alt="{{ post.title }}" class="rounded" width="60" height="60" style="object-fit: cover;" />
                    </td>
                    <td>
                      <a href="{% url 'posts:client_post_detail' post.id %}" class="text-dark"><h5 class="font-size-14 mb-1">{{ post.title }}</h5></a>
                      <p class="text-muted mb-0">{{ post.caption|truncatewords:15 }}</p>
                    </td>
                    <td>
                      <h5 class="mb-0">{{ post.comment_count }}</h5>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="3" class="text-center p-4">
                      <p class="text-muted my-2">No feedback has been left on any posts yet.</p>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script src="{% static 'admin/assets/libs/chart.js/Chart.bundle.min.js' %}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        var ctx = document.getElementById('statusPieChart').getContext('2d');
        var statusPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: {{ status_labels_json|safe }},
                datasets: [{
                    data: {{ status_distribution_json|safe }},
                    backgroundColor: [
                        '#34c38f', // Published (Success)
                        '#50a5f1', // Approved (Primary)
                        '#f46a6a', // Rejected (Danger)
                        '#f1b44c'  // Pending (Warning)
                    ],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    });
  </script>
{% endblock %}
